{
  "compilerOptions": {
    "module": "commonjs",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2023",
    "sourceMap": true,FYAfQmXfS9DHnSEBx18GhVqUQLO2Zt3JJr1v
    "outDir": "./dist",
    "baseUrl": "./",
    "paths": {
      "@/*": ["src/*"]
    },
    "incremental": true,
    "skipLibCheck": true,
    "strictNullChecks": true,
    "forceConsistentCasingInFileNames": true,
    "noImplicitAny": false,
    "strictBindCallApply": false,
    "noFallthroughCasesInSwitch": false
  }
}
SELECT
name AS database_name,
is_read_committed_snapshot_on
FROM sys.databases
WHERE name = DB_NAME();


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [convenio].[Mae_Beneficio](
	[idBeneficio] [nvarchar](max) NULL,
	[idGrupoBeneficio] [nvarchar](max) NULL,
	[idTipoCobertura] [nvarchar](max) NULL,
	[idSubtipoCobertura] [nvarchar](max) NULL,
	[codBeneficio] [nvarchar](max) NULL,
	[descripcion] [nvarchar](max) NULL,
	[desResumida] [nvarchar](max) NULL,
	[codGrupoBeneficio] [nvarchar](max) NULL,
	[codCobertura] [nvarchar](max) NULL,
	[subtipoCobert] [nvarchar](max) NULL,
	[estRegistro] [nvarchar](max) NULL,
	[codSistema] [nvarchar](max) NULL,
	[compania] [nvarchar](max) NULL,
	[codUsuarioCreadorSistema] [nvarchar](max) NULL,
	[fecCreacionSistema] [datetime] NULL,
	[codUsuarioUpdateSistema] [nvarchar](max) NULL,
	[fecUpdateSistema] [datetime] NULL,
	[codUsuarioCreador] [nvarchar](max) NULL,
	[fecCreacion] [datetime] NULL,
	[codUsuarioUpdate] [nvarchar](max) NULL,
	[fecUpdate] [datetime] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO


SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [convenio].[Mae_Log_Error_Merge]RIMARY KEY,
[FechaError] DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
[Procedimiento] NVARCHAR(100) NULL,
[TablaDestino] NVARCHAR(100) NULL,
[MensajeError] NVARCHAR(4000) NULL,
[LineaError] INT NULL,
[RegistrosProcesados] INT NULL,
[RegistrosTotales] INT NULL,
[Estado] NVARCHAR(20) NULL
) ON [PRIMARY]
G


CREATE TABLE [convenio].[Mae_Log_Error_Merge] (
[IdLog] INT IDENTITY(1,1) NOT NULL PRIMARY KEY,
[FechaError] DATETIME2 NOT NULL DEFAULT SYSDATETIME(),
[Procedimiento] NVARCHAR(100) NULL,
[TablaDestino] NVARCHAR(100) NULL,
[MensajeError] NVARCHAR(4000) NULL,
[LineaError] INT NULL,
[RegistrosProcesados] INT NULL,
[RegistrosTotales] INT NULL,
[Estado] NVARCHAR(20) NULL
) ON [PRIMARY];


_____
CREATE TABLE [convenio].[Mae_Beneficio_Temp](
[idBeneficio] [nvarchar](max) NULL,
[idGrupoBeneficio] [nvarchar](max) NULL,
[idTipoCobertura] [nvarchar](max) NULL,
[idSubtipoCobertura] [nvarchar](max) NULL,
[codBeneficio] [nvarchar](max) NULL,
[descripcion] [nvarchar](max) NULL,
[desResumida] [nvarchar](max) NULL,
[codGrupoBeneficio] [nvarchar](max) NULL,
[codCobertura] [nvarchar](max) NULL,
[subtipoCobert] [nvarchar](max) NULL,
[estRegistro] [nvarchar](max) NULL,
[codSistema] [nvarchar](max) NULL,
[compania] [nvarchar](max) NULL,
[codUsuarioCreadorSistema] [nvarchar](max) NULL,
[fecCreacionSistema] [datetime] NULL,
[codUsuarioUpdateSistema] [nvarchar](max) NULL,
[fecUpdateSistema] [datetime] NULL,
[codUsuarioCreador] [nvarchar](max) NULL,
[fecCreacion] [datetime] NULL,
[codUsuarioUpdate] [nvarchar](max) NULL,
[fecUpdate] [datetime] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

CREATE OR ALTER PROCEDURE [convenio].[USP_PRO_DeltaBeneficio]
@BatchSize INT = 500,
@EnableLogging BIT = 0
AS
BEGIN
SET NOCOUNT ON;
SET XACT_ABORT ON;

DECLARE @TotalRecords INT;
DECLARE @ProcessedRecords INT = 0;
DECLARE @BatchNumber INT = 1;
DECLARE @StartTime DATETIME2 = SYSDATETIME();
DECLARE @ErrorMessage NVARCHAR(4000);
DECLARE @TablaDestino NVARCHAR(100) = 'Mae_Beneficio';

-- Contar registros en staging
SELECT @TotalRecords = COUNT(*) FROM [convenio].[Mae_Beneficio_Temp];

-- Log inicial
IF @EnableLogging = 1
PRINT CONCAT('üîÑ Iniciando MERGE de ', @TotalRecords, ' registros...');

-- Validaci√≥n de duplicados
IF EXISTS (
SELECT [idBeneficio] FROM [convenio].[Mae_Beneficio_Temp] GROUP BY [idBeneficio] HAVING COUNT(*) > 1
)
BEGIN
RAISERROR('Error: Registros duplicados detectados en Mae_Beneficio_Temp.', 16, 1);
RETURN;
END;

BEGIN TRY
-- Crear tabla temporal para controlar los sub-lotes
CREATE TABLE #Batch (
[idBeneficio] NVARCHAR(MAX) NULL,
[idGrupoBeneficio] NVARCHAR(MAX) NULL,
[idTipoCobertura] NVARCHAR(MAX) NULL,
[idSubtipoCobertura] NVARCHAR(MAX) NULL,
[codBeneficio] NVARCHAR(MAX) NULL,
[descripcion] NVARCHAR(MAX) NULL,
[desResumida] NVARCHAR(MAX) NULL,
[codGrupoBeneficio] NVARCHAR(MAX) NULL,
[codCobertura] NVARCHAR(MAX) NULL,
[subtipoCobert] NVARCHAR(MAX) NULL,
[estRegistro] NVARCHAR(MAX) NULL,
[codSistema] NVARCHAR(MAX) NULL,
[compania] NVARCHAR(MAX) NULL,
[codUsuarioCreadorSistema] NVARCHAR(MAX) NULL,
[fecCreacionSistema] DATETIME NULL,
[codUsuarioUpdateSistema] NVARCHAR(MAX) NULL,
[fecUpdateSistema] DATETIME NULL,
[codUsuarioCreador] NVARCHAR(MAX) NULL,
[fecCreacion] DATETIME NULL,
[codUsuarioUpdate] NVARCHAR(MAX) NULL,
[fecUpdate] DATETIME NULL,
BatchGroup INT NOT NULL,
PRIMARY KEY CLUSTERED (BatchGroup, [idBeneficio])
);

-- Insertar los datos de staging dividi√©ndolos en grupos
INSERT INTO #Batch (
[idBeneficio], [idGrupoBeneficio], [idTipoCobertura], [idSubtipoCobertura], [codBeneficio], [descripcion], [desResumida],
[codGrupoBeneficio], [codCobertura], [subtipoCobert], [estRegistro], [codSistema], [compania], [codUsuarioCreadorSistema],
[fecCreacionSistema], [codUsuarioUpdateSistema], [fecUpdateSistema], [codUsuarioCreador], [fecCreacion], [codUsuarioUpdate],
[fecUpdate], BatchGroup
)
SELECT
[idBeneficio], [idGrupoBeneficio], [idTipoCobertura], [idSubtipoCobertura], [codBeneficio], [descripcion], [desResumida],
[codGrupoBeneficio], [codCobertura], [subtipoCobert], [estRegistro], [codSistema], [compania], [codUsuarioCreadorSistema],
[fecCreacionSistema], [codUsuarioUpdateSistema], [fecUpdateSistema], [codUsuarioCreador], [fecCreacion], [codUsuarioUpdate],
[fecUpdate],
((ROW_NUMBER() OVER (ORDER BY [idBeneficio]) - 1) / @BatchSize) + 1 AS BatchGroup
FROM [convenio].[Mae_Beneficio_Temp];

DECLARE @MaxBatchGroup INT;
SELECT @MaxBatchGroup = MAX(BatchGroup) FROM #Batch;

-- Procesar sub-lotes uno a uno
WHILE @BatchNumber <= @MaxBatchGroup
BEGIN
BEGIN TRANSACTION;

-- MERGE para cada sub-lote
MERGE [convenio].[Mae_Beneficio] AS TARGET
USING (
SELECT
[idBeneficio], [idGrupoBeneficio], [idTipoCobertura], [idSubtipoCobertura], [codBeneficio], [descripcion], [desResumida],
[codGrupoBeneficio], [codCobertura], [subtipoCobert], [estRegistro], [codSistema], [compania], [codUsuarioCreadorSistema],
[fecCreacionSistema], [codUsuarioUpdateSistema], [fecUpdateSistema], [codUsuarioCreador], [fecCreacion], [codUsuarioUpdate],
[fecUpdate]
FROM #Batch
WHERE BatchGroup = @BatchNumber
) AS SOURCE
ON TARGET.[idBeneficio] = SOURCE.[idBeneficio]

WHEN MATCHED AND (
TARGET.[idGrupoBeneficio] != SOURCE.[idGrupoBeneficio] OR
TARGET.[idTipoCobertura] != SOURCE.[idTipoCobertura] OR
TARGET.[idSubtipoCobertura] != SOURCE.[idSubtipoCobertura] OR
TARGET.[codBeneficio] != SOURCE.[codBeneficio] OR
TARGET.[descripcion] != SOURCE.[descripcion] OR
TARGET.[desResumida] != SOURCE.[desResumida] OR
TARGET.[codGrupoBeneficio] != SOURCE.[codGrupoBeneficio] OR
TARGET.[codCobertura] != SOURCE.[codCobertura] OR
TARGET.[subtipoCobert] != SOURCE.[subtipoCobert] OR
TARGET.[estRegistro] != SOURCE.[estRegistro] OR
TARGET.[codSistema] != SOURCE.[codSistema] OR
TARGET.[compania] != SOURCE.[compania] OR
TARGET.[codUsuarioCreadorSistema] != SOURCE.[codUsuarioCreadorSistema] OR
TARGET.[fecCreacionSistema] != SOURCE.[fecCreacionSistema] OR
TARGET.[codUsuarioUpdateSistema] != SOURCE.[codUsuarioUpdateSistema] OR
TARGET.[fecUpdateSistema] != SOURCE.[fecUpdateSistema] OR
TARGET.[codUsuarioCreador] != SOURCE.[codUsuarioCreador] OR
TARGET.[fecCreacion] != SOURCE.[fecCreacion] OR
TARGET.[codUsuarioUpdate] != SOURCE.[codUsuarioUpdate] OR
TARGET.[fecUpdate] != SOURCE.[fecUpdate]
) THEN
UPDATE SET
[idGrupoBeneficio] = SOURCE.[idGrupoBeneficio],
[idTipoCobertura] = SOURCE.[idTipoCobertura],
[idSubtipoCobertura] = SOURCE.[idSubtipoCobertura],
[codBeneficio] = SOURCE.[codBeneficio],
[descripcion] = SOURCE.[descripcion],
[desResumida] = SOURCE.[desResumida],
[codGrupoBeneficio] = SOURCE.[codGrupoBeneficio],
[codCobertura] = SOURCE.[codCobertura],
[subtipoCobert] = SOURCE.[subtipoCobert],
[estRegistro] = SOURCE.[estRegistro],
[codSistema] = SOURCE.[codSistema],
[compania] = SOURCE.[compania],
[codUsuarioCreadorSistema] = SOURCE.[codUsuarioCreadorSistema],
[fecCreacionSistema] = SOURCE.[fecCreacionSistema],
[codUsuarioUpdateSistema] = SOURCE.[codUsuarioUpdateSistema],
[fecUpdateSistema] = SOURCE.[fecUpdateSistema],
[codUsuarioCreador] = SOURCE.[codUsuarioCreador],
[fecCreacion] = SOURCE.[fecCreacion],
[codUsuarioUpdate] = SOURCE.[codUsuarioUpdate],
[fecUpdate] = SOURCE.[fecUpdate]

WHEN NOT MATCHED BY TARGET THEN
INSERT (
[idBeneficio], [idGrupoBeneficio], [idTipoCobertura], [idSubtipoCobertura], [codBeneficio], [descripcion], [desResumida],
[codGrupoBeneficio], [codCobertura], [subtipoCobert], [estRegistro], [codSistema], [compania], [codUsuarioCreadorSistema],
[fecCreacionSistema], [codUsuarioUpdateSistema], [fecUpdateSistema], [codUsuarioCreador], [fecCreacion], [codUsuarioUpdate],
[fecUpdate]
)
VALUES (
SOURCE.[idBeneficio], SOURCE.[idGrupoBeneficio], SOURCE.[idTipoCobertura], SOURCE.[idSubtipoCobertura], SOURCE.[codBeneficio],
SOURCE.[descripcion], SOURCE.[desResumida], SOURCE.[codGrupoBeneficio], SOURCE.[codCobertura], SOURCE.[subtipoCobert],
SOURCE.[estRegistro], SOURCE.[codSistema], SOURCE.[compania], SOURCE.[codUsuarioCreadorSistema], SOURCE.[fecCreacionSistema],
SOURCE.[codUsuarioUpdateSistema], SOURCE.[fecUpdateSistema], SOURCE.[codUsuarioCreador], SOURCE.[fecCreacion], SOURCE.[codUsuarioUpdate],
SOURCE.[fecUpdate]
);

COMMIT TRANSACTION;

-- Actualizar progreso
SELECT @ProcessedRecords = @ProcessedRecords + COUNT(*)
FROM #Batch WHERE BatchGroup = @BatchNumber;

IF @EnableLogging = 1
PRINT CONCAT('‚úÖ Sub-lote ', @BatchNumber, '/', @MaxBatchGroup, ' completado. Procesados: ', @ProcessedRecords);

SET @BatchNumber += 1;

-- Micro-pausa opcional
IF @BatchNumber <= @MaxBatchGroup
WAITFOR DELAY '00:00:00.010';
END;

-- Limpieza final
DROP TABLE #Batch;
TRUNCATE TABLE [convenio].[Mae_Beneficio_Temp];
IF @EnableLogging = 1
PRINT 'üßπ Tabla Mae_Beneficio_Temp limpiada con TRUNCATE.';

-- Log final
DECLARE @Duration INT = DATEDIFF(MILLISECOND, @StartTime, SYSDATETIME());
DECLARE @ResultMessage NVARCHAR(500) = CONCAT(
'‚úÖ MERGE completado. Total: ', @TotalRecords,
', Tiempo: ', @Duration, ' ms',
', Promedio: ', CASE WHEN @TotalRecords > 0 THEN @Duration/@TotalRecords ELSE 0 END, ' ms/reg'
);
PRINT @ResultMessage;

SELECT
@TotalRecords AS TotalRecords,
@ProcessedRecords AS ProcessedRecords,
@Duration AS DurationMs,
CASE WHEN @TotalRecords > 0 THEN @Duration/@TotalRecords ELSE 0 END AS AvgMsPerRecord,
'SUCCESS' AS Status;

END TRY
BEGIN CATCH
-- Manejo de errores
IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
IF OBJECT_ID('tempdb..#Batch') IS NOT NULL DROP TABLE #Batch;

SET @ErrorMessage = CONCAT('‚ùå Error en sub-lote ', @BatchNumber, ': ', ERROR_MESSAGE(), ' (L√≠nea: ', ERROR_LINE(), ')');
PRINT @ErrorMessage;

-- Registro de error (si existe tabla de log)
IF OBJECT_ID('convenio.Mae_Log_Error_Merge') IS NOT NULL
BEGIN
INSERT INTO [convenio].[Mae_Log_Error_Merge] (
[Procedimiento], [TablaDestino], [MensajeError], [LineaError],
[RegistrosProcesados], [RegistrosTotales], [Estado]
)
VALUES (
'sp_MergeProductosDatabricks', @TablaDestino, ERROR_MESSAGE(),
ERROR_LINE(), @ProcessedRecords, @TotalRecords, 'ERROR'
);
END

-- Retorno en caso de error
SELECT
@ProcessedRecords AS ProcessedRecords,
@TotalRecords AS TotalRecords,
@ErrorMessage AS ErrorMessage,
'ERROR' AS Status;

THROW;
END CATCH;
END;


*****

CREATE OR ALTER PROCEDURE [convenio].[USP_PRO_DeltaBeneficio]
@BatchSize INT = 500,
@EnableLogging BIT = 0
AS
BEGIN
SET NOCOUNT ON;
SET XACT_ABORT ON;

DECLARE @TotalRecords INT;
DECLARE @ProcessedRecords INT = 0;
DECLARE @BatchNumber INT = 1;
DECLARE @StartTime DATETIME2 = SYSDATETIME();
DECLARE @ErrorMessage NVARCHAR(4000);
DECLARE @TablaDestino NVARCHAR(100) = 'Mae_Beneficio';

-- Contar registros v√°lidos
SELECT @TotalRecords = COUNT(*) FROM [convenio].[Mae_Beneficio_Temp] WHERE idBeneficio IS NOT NULL;

IF @EnableLogging = 1
PRINT CONCAT(' Iniciando MERGE de ', @TotalRecords, ' registros v√°lidos...');

-- Validaci√≥n de duplicados
IF EXISTS (
SELECT idBeneficio
FROM [convenio].[Mae_Beneficio_Temp]
WHERE idBeneficio IS NOT NULL
GROUP BY idBeneficio
HAVING COUNT(*) > 1
)
BEGIN
RAISERROR('Error: Registros duplicados detectados en Mae_Beneficio_Temp.', 16, 1);
RETURN;
END;

BEGIN TRY
CREATE TABLE #Batch (
idBeneficio NVARCHAR(100) NOT NULL,
idGrupoBeneficio NVARCHAR(MAX) NULL,
idTipoCobertura NVARCHAR(MAX) NULL,
idSubtipoCobertura NVARCHAR(MAX) NULL,
codBeneficio NVARCHAR(MAX) NULL,
descripcion NVARCHAR(MAX) NULL,
desResumida NVARCHAR(MAX) NULL,
codGrupoBeneficio NVARCHAR(MAX) NULL,
codCobertura NVARCHAR(MAX) NULL,
subtipoCobert NVARCHAR(MAX) NULL,
estRegistro NVARCHAR(MAX) NULL,
codSistema NVARCHAR(MAX) NULL,
compania NVARCHAR(MAX) NULL,
codUsuarioCreadorSistema NVARCHAR(MAX) NULL,
fecCreacionSistema DATETIME NULL,
codUsuarioUpdateSistema NVARCHAR(MAX) NULL,
fecUpdateSistema DATETIME NULL,
codUsuarioCreador NVARCHAR(MAX) NULL,
fecCreacion DATETIME NULL,
codUsuarioUpdate NVARCHAR(MAX) NULL,
fecUpdate DATETIME NULL,
BatchGroup INT NOT NULL,
PRIMARY KEY CLUSTERED (BatchGroup, idBeneficio)
);

INSERT INTO #Batch (
idBeneficio, idGrupoBeneficio, idTipoCobertura, idSubtipoCobertura,
codBeneficio, descripcion, desResumida, codGrupoBeneficio,
codCobertura, subtipoCobert, estRegistro, codSistema,
compania, codUsuarioCreadorSistema, fecCreacionSistema,
codUsuarioUpdateSistema, fecUpdateSistema, codUsuarioCreador,
fecCreacion, codUsuarioUpdate, fecUpdate, BatchGroup
)
SELECT
idBeneficio, idGrupoBeneficio, idTipoCobertura, idSubtipoCobertura,
codBeneficio, descripcion, desResumida, codGrupoBeneficio,
codCobertura, subtipoCobert, estRegistro, codSistema,
compania, codUsuarioCreadorSistema, fecCreacionSistema,
codUsuarioUpdateSistema, fecUpdateSistema, codUsuarioCreador,
fecCreacion, codUsuarioUpdate, fecUpdate,
((ROW_NUMBER() OVER (ORDER BY idBeneficio) - 1) / @BatchSize) + 1
FROM [convenio].[Mae_Beneficio_Temp]
WHERE idBeneficio IS NOT NULL;

DECLARE @MaxBatchGroup INT;
SELECT @MaxBatchGroup = MAX(BatchGroup) FROM #Batch;

WHILE @BatchNumber <= @MaxBatchGroup
BEGIN
BEGIN TRANSACTION;

MERGE [convenio].[Mae_Beneficio] AS TARGET
USING (
SELECT * FROM #Batch WHERE BatchGroup = @BatchNumber
) AS SOURCE
ON TARGET.idBeneficio = SOURCE.idBeneficio

WHEN MATCHED AND (
ISNULL(TARGET.idGrupoBeneficio,'') != ISNULL(SOURCE.idGrupoBeneficio,'') OR
ISNULL(TARGET.idTipoCobertura,'') != ISNULL(SOURCE.idTipoCobertura,'') OR
ISNULL(TARGET.idSubtipoCobertura,'') != ISNULL(SOURCE.idSubtipoCobertura,'') OR
ISNULL(TARGET.codBeneficio,'') != ISNULL(SOURCE.codBeneficio,'') OR
ISNULL(TARGET.descripcion,'') != ISNULL(SOURCE.descripcion,'') OR
ISNULL(TARGET.desResumida,'') != ISNULL(SOURCE.desResumida,'') OR
ISNULL(TARGET.codGrupoBeneficio,'') != ISNULL(SOURCE.codGrupoBeneficio,'') OR
ISNULL(TARGET.codCobertura,'') != ISNULL(SOURCE.codCobertura,'') OR
ISNULL(TARGET.subtipoCobert,'') != ISNULL(SOURCE.subtipoCobert,'') OR
ISNULL(TARGET.estRegistro,'') != ISNULL(SOURCE.estRegistro,'') OR
ISNULL(TARGET.codSistema,'') != ISNULL(SOURCE.codSistema,'') OR
ISNULL(TARGET.compania,'') != ISNULL(SOURCE.compania,'') OR
ISNULL(TARGET.codUsuarioCreadorSistema,'') != ISNULL(SOURCE.codUsuarioCreadorSistema,'') OR
ISNULL(TARGET.fecCreacionSistema,'1900-01-01') != ISNULL(SOURCE.fecCreacionSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioUpdateSistema,'') != ISNULL(SOURCE.codUsuarioUpdateSistema,'') OR
ISNULL(TARGET.fecUpdateSistema,'1900-01-01') != ISNULL(SOURCE.fecUpdateSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioCreador,'') != ISNULL(SOURCE.codUsuarioCreador,'') OR
ISNULL(TARGET.fecCreacion,'1900-01-01') != ISNULL(SOURCE.fecCreacion,'1900-01-01') OR
ISNULL(TARGET.codUsuarioUpdate,'') != ISNULL(SOURCE.codUsuarioUpdate,'') OR
ISNULL(TARGET.fecUpdate,'1900-01-01') != ISNULL(SOURCE.fecUpdate,'1900-01-01')
) THEN
UPDATE SET
TARGET.idGrupoBeneficio = SOURCE.idGrupoBeneficio,
TARGET.idTipoCobertura = SOURCE.idTipoCobertura,
TARGET.idSubtipoCobertura = SOURCE.idSubtipoCobertura,
TARGET.codBeneficio = SOURCE.codBeneficio,
TARGET.descripcion = SOURCE.descripcion,
TARGET.desResumida = SOURCE.desResumida,
TARGET.codGrupoBeneficio = SOURCE.codGrupoBeneficio,
TARGET.codCobertura = SOURCE.codCobertura,
TARGET.subtipoCobert = SOURCE.subtipoCobert,
TARGET.estRegistro = SOURCE.estRegistro,
TARGET.codSistema = SOURCE.codSistema,
TARGET.compania = SOURCE.compania,
TARGET.codUsuarioCreadorSistema = SOURCE.codUsuarioCreadorSistema,
TARGET.fecCreacionSistema = SOURCE.fecCreacionSistema,
TARGET.codUsuarioUpdateSistema = SOURCE.codUsuarioUpdateSistema,
TARGET.fecUpdateSistema = SOURCE.fecUpdateSistema,
TARGET.codUsuarioCreador = SOURCE.codUsuarioCreador,
TARGET.fecCreacion = SOURCE.fecCreacion,
TARGET.codUsuarioUpdate = SOURCE.codUsuarioUpdate,
TARGET.fecUpdate = SOURCE.fecUpdate

WHEN NOT MATCHED BY TARGET THEN
INSERT (
idBeneficio, idGrupoBeneficio, idTipoCobertura, idSubtipoCobertura,
codBeneficio, descripcion, desResumida, codGrupoBeneficio,
codCobertura, subtipoCobert, estRegistro, codSistema,
compania, codUsuarioCreadorSistema, fecCreacionSistema,
codUsuarioUpdateSistema, fecUpdateSistema, codUsuarioCreador,
fecCreacion, codUsuarioUpdate, fecUpdate
)
VALUES (
SOURCE.idBeneficio, SOURCE.idGrupoBeneficio, SOURCE.idTipoCobertura, SOURCE.idSubtipoCobertura,
SOURCE.codBeneficio, SOURCE.descripcion, SOURCE.desResumida, SOURCE.codGrupoBeneficio,
SOURCE.codCobertura, SOURCE.subtipoCobert, SOURCE.estRegistro, SOURCE.codSistema,
SOURCE.compania, SOURCE.codUsuarioCreadorSistema, SOURCE.fecCreacionSistema,
SOURCE.codUsuarioUpdateSistema, SOURCE.fecUpdateSistema, SOURCE.codUsuarioCreador,
SOURCE.fecCreacion, SOURCE.codUsuarioUpdate, SOURCE.fecUpdate
);

COMMIT TRANSACTION;

SELECT @ProcessedRecords += COUNT(*) FROM #Batch WHERE BatchGroup = @BatchNumber;

IF @EnableLogging = 1
PRINT CONCAT(' Sub-lote ', @BatchNumber, '/', @MaxBatchGroup, ' completado. Procesados: ', @ProcessedRecords);

SET @BatchNumber += 1;
IF @BatchNumber <= @MaxBatchGroup
WAITFOR DELAY '00:00:00.010';
END;

DROP TABLE #Batch;
TRUNCATE TABLE [convenio].[Mae_Beneficio_Temp];

IF @EnableLogging = 1
PRINT ' Tabla Mae_Beneficio_Temp limpiada con TRUNCATE.';

DECLARE @Duration INT = DATEDIFF(MILLISECOND, @StartTime, SYSDATETIME());

PRINT CONCAT(' MERGE completado. Total: ', @TotalRecords, ', Tiempo: ', @Duration, ' ms, Promedio: ',
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END, ' ms/reg');

SELECT
@TotalRecords AS TotalRecords,
@ProcessedRecords AS ProcessedRecords,
@Duration AS DurationMs,
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END AS AvgMsPerRecord,
'SUCCESS' AS Status;

END TRY
BEGIN CATCH
IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
IF OBJECT_ID('tempdb..#Batch') IS NOT NULL DROP TABLE #Batch;

SET @ErrorMessage = CONCAT(' Error en sub-lote ', @BatchNumber, ': ', ERROR_MESSAGE(), ' (L√≠nea: ', ERROR_LINE(), ')');
PRINT @ErrorMessage;

IF OBJECT_ID('convenio.Mae_Log_Error_Merge') IS NOT NULL
BEGIN
INSERT INTO [convenio].[Mae_Log_Error_Merge] (
Procedimiento, TablaDestino, MensajeError, LineaError,
RegistrosProcesados, RegistrosTotales, Estado
)
VALUES (
'USP_PRO_DeltaBeneficio', @TablaDestino, ERROR_MESSAGE(),
ERROR_LINE(), @ProcessedRecords, @TotalRecords, 'ERROR'
);
END

SELECT
@ProcessedRecords AS ProcessedRecords,
@TotalRecords AS TotalRecords,
@ErrorMessage AS ErrorMessage,
'ERROR' AS Status;

THROW;
END CATCH;
END;


---
INSERT INTO [convenio].[Mae_Beneficio_Temp] (
idBeneficio, idGrupoBeneficio, idTipoCobertura, idSubtipoCobertura,
codBeneficio, descripcion, desResumida, codGrupoBeneficio,
codCobertura, subtipoCobert, estRegistro, codSistema, compania,
codUsuarioCreadorSistema, fecCreacionSistema, codUsuarioUpdateSistema,
fecUpdateSistema, codUsuarioCreador, fecCreacion, codUsuarioUpdate, fecUpdate
)
VALUES
('B001', 'G01', 'T01', 'ST01', 'CB001', 'Beneficio 1', 'B1', 'CG01', 'CC01', 'SC01', 'A', 'SYS1', 'COMP1',
'USR1', GETDATE(), NULL, NULL, 'USR1', GETDATE(), NULL, NULL),
('B002', 'G02', 'T02', 'ST02', 'CB002', 'Beneficio 2', 'B2', 'CG02', 'CC02', 'SC02', 'A', 'SYS1', 'COMP1',
'USR1', GETDATE(), NULL, NULL, 'USR1', GETDATE(), NULL, NULL);


EXEC [convenio].[USP_PRO_DeltaBeneficio]
@BatchSize = 5000,
@EnableLogging = 1;

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [convenio].[Mae_BeneficioEPS](
	[idBeneficioEps] [nvarchar](max) NULL,
	[idBeneficio] [nvarchar](max) NULL,
	[codBeneficio] [nvarchar](max) NULL,
	[tipoGastoPrestacion] [nvarchar](max) NULL,
	[indRequiereCartaGarantia] [nvarchar](max) NULL,
	[indBeneficioAdicional] [nvarchar](max) NULL,
	[indBeneficioPrincipal] [nvarchar](max) NULL,
	[indProcEspeciales] [nvarchar](max) NULL,
	[tipoPEAS] [nvarchar](max) NULL,
	[indBeneficioComun] [nvarchar](max) NULL,
	[codGrupoServicio] [int] NULL,
	[indMostrarCG] [nvarchar](max) NULL,
	[codSistema] [nvarchar](max) NULL,
	[estRegistro] [nvarchar](max) NULL,
	[codUsuarioCreadorSistema] [nvarchar](max) NULL,
	[fecCreacionSistema] [datetime] NULL,
	[codUsuarioUpdateSistema] [nvarchar](max) NULL,
	[fecUpdateSistema] [datetime] NULL,
	[codUsuarioCreador] [nvarchar](max) NULL,
	[fecCreacion] [datetime] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO


    [16:22, 30/5/2025] David üòé Arquitecto Pacifico: CREATE TABLE [convenio].[Mae_BeneficioEPS_Temp] (
[idBeneficioEps] NVARCHAR(MAX) NULL,
[idBeneficio] NVARCHAR(MAX) NULL,
[codBeneficio] NVARCHAR(MAX) NULL,
[tipoGastoPrestacion] NVARCHAR(MAX) NULL,
[indRequiereCartaGarantia] NVARCHAR(MAX) NULL,
[indBeneficioAdicional] NVARCHAR(MAX) NULL,
[indBeneficioPrincipal] NVARCHAR(MAX) NULL,
[indProcEspeciales] NVARCHAR(MAX) NULL,
[tipoPEAS] NVARCHAR(MAX) NULL,
[indBeneficioComun] NVARCHAR(MAX) NULL,
[codGrupoServicio] INT NULL,
[indMostrarCG] NVARCHAR(MAX) NULL,
[codSistema] NVARCHAR(MAX) NULL,
[estRegistro] NVARCHAR(MAX) NULL,
[codUsuarioCreadorSistema] NVARCHAR(MAX) NULL,
[fecCreacionSistema] DATETIME NULL,
[codUsuarioUpdateSistema] NVARCHAR(MAX) NU‚Ä¶
[16:22, 30/5/2025] David üòé Arquitecto Pacifico: CREATE OR ALTER PROCEDURE [convenio].[USP_PRO_DeltaBeneficioEPS]
@BatchSize INT = 500,
@EnableLogging BIT = 0
AS
BEGIN
SET NOCOUNT ON;
SET XACT_ABORT ON;

DECLARE @TotalRecords INT;
DECLARE @ProcessedRecords INT = 0;
DECLARE @BatchNumber INT = 1;
DECLARE @StartTime DATETIME2 = SYSDATETIME();
DECLARE @ErrorMessage NVARCHAR(4000);
DECLARE @TablaDestino NVARCHAR(100) = 'Mae_BeneficioEPS';

SELECT @TotalRecords = COUNT(*) FROM [convenio].[Mae_BeneficioEPS_Temp] WHERE idBeneficioEps IS NOT NULL;

IF @EnableLogging = 1
PRINT CONCAT('üîÑ Iniciando MERGE de ', @TotalRecords, ' registros v√°lidos...');

IF EXISTS (
SELECT idBeneficioEps
FROM [convenio].[Mae_BeneficioEPS_Temp]
WHERE idBeneficioEps IS NOT NULL
GROUP BY idBeneficioEps
HAVING COUNT(*) > 1
)
BEGIN
RAISERROR('Error: Registros duplicados detectados en Mae_BeneficioEPS_Temp.', 16, 1);
RETURN;
END;

BEGIN TRY
CREATE TABLE #Batch (
idBeneficioEps NVARCHAR(MAX) NOT NULL,
idBeneficio NVARCHAR(MAX) NULL,
codBeneficio NVARCHAR(MAX) NULL,
tipoGastoPrestacion NVARCHAR(MAX) NULL,
indRequiereCartaGarantia NVARCHAR(MAX) NULL,
indBeneficioAdicional NVARCHAR(MAX) NULL,
indBeneficioPrincipal NVARCHAR(MAX) NULL,
indProcEspeciales NVARCHAR(MAX) NULL,
tipoPEAS NVARCHAR(MAX) NULL,
indBeneficioComun NVARCHAR(MAX) NULL,
codGrupoServicio INT NULL,
indMostrarCG NVARCHAR(MAX) NULL,
codSistema NVARCHAR(MAX) NULL,
estRegistro NVARCHAR(MAX) NULL,
codUsuarioCreadorSistema NVARCHAR(MAX) NULL,
fecCreacionSistema DATETIME NULL,
codUsuarioUpdateSistema NVARCHAR(MAX) NULL,
fecUpdateSistema DATETIME NULL,
codUsuarioCreador NVARCHAR(MAX) NULL,
fecCreacion DATETIME NULL,
BatchGroup INT NOT NULL,
PRIMARY KEY CLUSTERED (BatchGroup, idBeneficioEps)
);

INSERT INTO #Batch (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion, BatchGroup
)
SELECT
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion,
((ROW_NUMBER() OVER (ORDER BY idBeneficioEps) - 1) / @BatchSize) + 1
FROM [convenio].[Mae_BeneficioEPS_Temp]
WHERE idBeneficioEps IS NOT NULL;

DECLARE @MaxBatchGroup INT;
SELECT @MaxBatchGroup = MAX(BatchGroup) FROM #Batch;

WHILE @BatchNumber <= @MaxBatchGroup
BEGIN
BEGIN TRANSACTION;

MERGE [convenio].[Mae_BeneficioEPS] AS TARGET
USING (
SELECT * FROM #Batch WHERE BatchGroup = @BatchNumber
) AS SOURCE
ON TARGET.idBeneficioEps = SOURCE.idBeneficioEps

WHEN MATCHED AND (
ISNULL(TARGET.idBeneficio,'') != ISNULL(SOURCE.idBeneficio,'') OR
ISNULL(TARGET.codBeneficio,'') != ISNULL(SOURCE.codBeneficio,'') OR
ISNULL(TARGET.tipoGastoPrestacion,'') != ISNULL(SOURCE.tipoGastoPrestacion,'') OR
ISNULL(TARGET.indRequiereCartaGarantia,'') != ISNULL(SOURCE.indRequiereCartaGarantia,'') OR
ISNULL(TARGET.indBeneficioAdicional,'') != ISNULL(SOURCE.indBeneficioAdicional,'') OR
ISNULL(TARGET.indBeneficioPrincipal,'') != ISNULL(SOURCE.indBeneficioPrincipal,'') OR
ISNULL(TARGET.indProcEspeciales,'') != ISNULL(SOURCE.indProcEspeciales,'') OR
ISNULL(TARGET.tipoPEAS,'') != ISNULL(SOURCE.tipoPEAS,'') OR
ISNULL(TARGET.indBeneficioComun,'') != ISNULL(SOURCE.indBeneficioComun,'') OR
ISNULL(TARGET.codGrupoServicio, -1) != ISNULL(SOURCE.codGrupoServicio, -1) OR
ISNULL(TARGET.indMostrarCG,'') != ISNULL(SOURCE.indMostrarCG,'') OR
ISNULL(TARGET.codSistema,'') != ISNULL(SOURCE.codSistema,'') OR
ISNULL(TARGET.estRegistro,'') != ISNULL(SOURCE.estRegistro,'') OR
ISNULL(TARGET.codUsuarioCreadorSistema,'') != ISNULL(SOURCE.codUsuarioCreadorSistema,'') OR
ISNULL(TARGET.fecCreacionSistema,'1900-01-01') != ISNULL(SOURCE.fecCreacionSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioUpdateSistema,'') != ISNULL(SOURCE.codUsuarioUpdateSistema,'') OR
ISNULL(TARGET.fecUpdateSistema,'1900-01-01') != ISNULL(SOURCE.fecUpdateSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioCreador,'') != ISNULL(SOURCE.codUsuarioCreador,'') OR
ISNULL(TARGET.fecCreacion,'1900-01-01') != ISNULL(SOURCE.fecCreacion,'1900-01-01')
) THEN
UPDATE SET
TARGET.idBeneficio = SOURCE.idBeneficio,
TARGET.codBeneficio = SOURCE.codBeneficio,
TARGET.tipoGastoPrestacion = SOURCE.tipoGastoPrestacion,
TARGET.indRequiereCartaGarantia = SOURCE.indRequiereCartaGarantia,
TARGET.indBeneficioAdicional = SOURCE.indBeneficioAdicional,
TARGET.indBeneficioPrincipal = SOURCE.indBeneficioPrincipal,
TARGET.indProcEspeciales = SOURCE.indProcEspeciales,
TARGET.tipoPEAS = SOURCE.tipoPEAS,
TARGET.indBeneficioComun = SOURCE.indBeneficioComun,
TARGET.codGrupoServicio = SOURCE.codGrupoServicio,
TARGET.indMostrarCG = SOURCE.indMostrarCG,
TARGET.codSistema = SOURCE.codSistema,
TARGET.estRegistro = SOURCE.estRegistro,
TARGET.codUsuarioCreadorSistema = SOURCE.codUsuarioCreadorSistema,
TARGET.fecCreacionSistema = SOURCE.fecCreacionSistema,
TARGET.codUsuarioUpdateSistema = SOURCE.codUsuarioUpdateSistema,
TARGET.fecUpdateSistema = SOURCE.fecUpdateSistema,
TARGET.codUsuarioCreador = SOURCE.codUsuarioCreador,
TARGET.fecCreacion = SOURCE.fecCreacion

WHEN NOT MATCHED BY TARGET THEN
INSERT (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion
)
VALUES (
SOURCE.idBeneficioEps, SOURCE.idBeneficio, SOURCE.codBeneficio, SOURCE.tipoGastoPrestacion,
SOURCE.indRequiereCartaGarantia, SOURCE.indBeneficioAdicional, SOURCE.indBeneficioPrincipal,
SOURCE.indProcEspeciales, SOURCE.tipoPEAS, SOURCE.indBeneficioComun, SOURCE.codGrupoServicio,
SOURCE.indMostrarCG, SOURCE.codSistema, SOURCE.estRegistro, SOURCE.codUsuarioCreadorSistema,
SOURCE.fecCreacionSistema, SOURCE.codUsuarioUpdateSistema, SOURCE.fecUpdateSistema,
SOURCE.codUsuarioCreador, SOURCE.fecCreacion
);

COMMIT TRANSACTION;

SELECT @ProcessedRecords += COUNT(*) FROM #Batch WHERE BatchGroup = @BatchNumber;

IF @EnableLogging = 1
PRINT CONCAT('‚úÖ Sub-lote ', @BatchNumber, '/', @MaxBatchGroup, ' completado. Procesados: ', @ProcessedRecords);

SET @BatchNumber += 1;
IF @BatchNumber <= @MaxBatchGroup
WAITFOR DELAY '00:00:00.010';
END;

DROP TABLE #Batch;
TRUNCATE TABLE [convenio].[Mae_BeneficioEPS_Temp];

IF @EnableLogging = 1
PRINT 'üßπ Tabla Mae_BeneficioEPS_Temp limpiada con TRUNCATE.';

DECLARE @Duration INT = DATEDIFF(MILLISECOND, @StartTime, SYSDATETIME());

PRINT CONCAT('‚úÖ MERGE completado. Total: ', @TotalRecords, ', Tiempo: ', @Duration, ' ms, Promedio: ',
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END, ' ms/reg');

SELECT
@TotalRecords AS TotalRecords,
@ProcessedRecords AS ProcessedRecords,
@Duration AS DurationMs,
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END AS AvgMsPerRecord,
'SUCCESS' AS Status;

END TRY
BEGIN CATCH
IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
IF OBJECT_ID('tempdb..#Batch') IS NOT NULL DROP TABLE #Batch;

SET @ErrorMessage = CONCAT('‚ùå Error en sub-lote ', @BatchNumber, ': ', ERROR_MESSAGE(), ' (L√≠nea: ', ERROR_LINE(), ')');
PRINT @ErrorMessage;

IF OBJECT_ID('convenio.Mae_Log_Error_Merge') IS NOT NULL
BEGIN
INSERT INTO [convenio].[Mae_Log_Error_Merge] (
Procedimiento, TablaDestino, MensajeError, LineaError,
RegistrosProcesados, RegistrosTotales, Estado
)
VALUES (
'USP_PRO_DeltaBeneficioEPS', @TablaDestino, ERROR_MESSAGE(),
ERROR_LINE(), @ProcessedRecords, @TotalRecords, 'ERROR'
);
END

SELECT
@ProcessedRecords AS ProcessedRecords,
@TotalRecords AS TotalRecords,
@ErrorMessage AS ErrorMessage,
'ERROR' AS Status;

THROW;
END CATCH;
END;

//////////////////////////////

[16:33, 30/5/2025] David üòé Arquitecto Pacifico: CREATE OR ALTER PROCEDURE [convenio].[USP_PRO_DeltaBeneficioEPS]
@BatchSize INT = 500,
@EnableLogging BIT = 0
AS
BEGIN
SET NOCOUNT ON;
SET XACT_ABORT ON;

DECLARE @TotalRecords INT;
DECLARE @ProcessedRecords INT = 0;
DECLARE @BatchNumber INT = 1;
DECLARE @StartTime DATETIME2 = SYSDATETIME();
DECLARE @ErrorMessage NVARCHAR(4000);
DECLARE @TablaDestino NVARCHAR(100) = 'Mae_BeneficioEPS';

SELECT @TotalRecords = COUNT(*) FROM [convenio].[Mae_BeneficioEPS_Temp] WHERE idBeneficioEps IS NOT NULL;

IF @EnableLogging = 1
PRINT CONCAT('üîÑ Iniciando MERGE de ', @TotalRecords, ' registros v√°lidos...');

IF EXISTS (
SELECT idBeneficioEps
FROM [convenio].[Mae_BeneficioEPS_Temp]
WHERE idBeneficioEps IS NOT NULL
GROUP BY idBeneficioEps
HAVING COUNT(*) > 1
)
BEGIN
RAISERROR('Error: Registros duplicados detectados en Mae_BeneficioEPS_Temp.', 16, 1);
RETURN;
END;

BEGIN TRY
CREATE TABLE #Batch (
idBeneficioEps NVARCHAR(100) NOT NULL,
idBeneficio NVARCHAR(100) NULL,
codBeneficio NVARCHAR(100) NULL,
tipoGastoPrestacion NVARCHAR(100) NULL,
indRequiereCartaGarantia NVARCHAR(10) NULL,
indBeneficioAdicional NVARCHAR(10) NULL,
indBeneficioPrincipal NVARCHAR(10) NULL,
indProcEspeciales NVARCHAR(10) NULL,
tipoPEAS NVARCHAR(50) NULL,
indBeneficioComun NVARCHAR(10) NULL,
codGrupoServicio INT NULL,
indMostrarCG NVARCHAR(10) NULL,
codSistema NVARCHAR(50) NULL,
estRegistro NVARCHAR(10) NULL,
codUsuarioCreadorSistema NVARCHAR(100) NULL,
fecCreacionSistema DATETIME NULL,
codUsuarioUpdateSistema NVARCHAR(100) NULL,
fecUpdateSistema DATETIME NULL,
codUsuarioCreador NVARCHAR(100) NULL,
fecCreacion DATETIME NULL,
BatchGroup INT NOT NULL,
PRIMARY KEY CLUSTERED (BatchGroup, idBeneficioEps)
);

INSERT INTO #Batch (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion, BatchGroup
)
SELECT
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion,
((ROW_NUMBER() OVER (ORDER BY idBeneficioEps) - 1) / @BatchSize) + 1
FROM [convenio].[Mae_BeneficioEPS_Temp]
WHERE idBeneficioEps IS NOT NULL;

DECLARE @MaxBatchGroup INT;
SELECT @MaxBatchGroup = MAX(BatchGroup) FROM #Batch;

WHILE @BatchNumber <= @MaxBatchGroup
BEGIN
BEGIN TRANSACTION;

MERGE [convenio].[Mae_BeneficioEPS] AS TARGET
USING (
SELECT * FROM #Batch WHERE BatchGroup = @BatchNumber
) AS SOURCE
ON TARGET.idBeneficioEps = SOURCE.idBeneficioEps

WHEN MATCHED AND (
ISNULL(TARGET.idBeneficio,'') != ISNULL(SOURCE.idBeneficio,'') OR
ISNULL(TARGET.codBeneficio,'') != ISNULL(SOURCE.codBeneficio,'') OR
ISNULL(TARGET.tipoGastoPrestacion,'') != ISNULL(SOURCE.tipoGastoPrestacion,'') OR
ISNULL(TARGET.indRequiereCartaGarantia,'') != ISNULL(SOURCE.indRequiereCartaGarantia,'') OR
ISNULL(TARGET.indBeneficioAdicional,'') != ISNULL(SOURCE.indBeneficioAdicional,'') OR
ISNULL(TARGET.indBeneficioPrincipal,'') != ISNULL(SOURCE.indBeneficioPrincipal,'') OR
ISNULL(TARGET.indProcEspeciales,'') != ISNULL(SOURCE.indProcEspeciales,'') OR
ISNULL(TARGET.tipoPEAS,'') != ISNULL(SOURCE.tipoPEAS,'') OR
ISNULL(TARGET.indBeneficioComun,'') != ISNULL(SOURCE.indBeneficioComun,'') OR
ISNULL(TARGET.codGrupoServicio, -1) != ISNULL(SOURCE.codGrupoServicio, -1) OR
ISNULL(TARGET.indMostrarCG,'') != ISNULL(SOURCE.indMostrarCG,'') OR
ISNULL(TARGET.codSistema,'') != ISNULL(SOURCE.codSistema,'') OR
ISNULL(TARGET.estRegistro,'') != ISNULL(SOURCE.estRegistro,'') OR
ISNULL(TARGET.codUsuarioCreadorSistema,'') != ISNULL(SOURCE.codUsuarioCreadorSistema,'') OR
ISNULL(TARGET.fecCreacionSistema,'1900-01-01') != ISNULL(SOURCE.fecCreacionSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioUpdateSistema,'') != ISNULL(SOURCE.codUsuarioUpdateSistema,'') OR
ISNULL(TARGET.fecUpdateSistema,'1900-01-01') != ISNULL(SOURCE.fecUpdateSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioCreador,'') != ISNULL(SOURCE.codUsuarioCreador,'') OR
ISNULL(TARGET.fecCreacion,'1900-01-01') != ISNULL(SOURCE.fecCreacion,'1900-01-01')
) THEN
UPDATE SET
TARGET.idBeneficio = SOURCE.idBeneficio,
TARGET.codBeneficio = SOURCE.codBeneficio,
TARGET.tipoGastoPrestacion = SOURCE.tipoGastoPrestacion,
TARGET.indRequiereCartaGarantia = SOURCE.indRequiereCartaGarantia,
TARGET.indBeneficioAdicional = SOURCE.indBeneficioAdicional,
TARGET.indBeneficioPrincipal = SOURCE.indBeneficioPrincipal,
TARGET.indProcEspeciales = SOURCE.indProcEspeciales,
TARGET.tipoPEAS = SOURCE.tipoPEAS,
TARGET.indBeneficioComun = SOURCE.indBeneficioComun,
TARGET.codGrupoServicio = SOURCE.codGrupoServicio,
TARGET.indMostrarCG = SOURCE.indMostrarCG,
TARGET.codSistema = SOURCE.codSistema,
TARGET.estRegistro = SOURCE.estRegistro,
TARGET.codUsuarioCreadorSistema = SOURCE.codUsuarioCreadorSistema,
TARGET.fecCreacionSistema = SOURCE.fecCreacionSistema,
TARGET.codUsuarioUpdateSistema = SOURCE.codUsuarioUpdateSistema,
TARGET.fecUpdateSistema = SOURCE.fecUpdateSistema,
TARGET.codUsuarioCreador = SOURCE.codUsuarioCreador,
TARGET.fecCreacion = SOURCE.fecCreacion

WHEN NOT MATCHED BY TARGET THEN
INSERT (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion
)
VALUES (
SOURCE.idBeneficioEps, SOURCE.idBeneficio, SOURCE.codBeneficio, SOURCE.tipoGastoPrestacion,
SOURCE.indRequiereCartaGarantia, SOURCE.indBeneficioAdicional, SOURCE.indBeneficioPrincipal,
SOURCE.indProcEspeciales, SOURCE.tipoPEAS, SOURCE.indBeneficioComun, SOURCE.codGrupoServicio,
SOURCE.indMostrarCG, SOURCE.codSistema, SOURCE.estRegistro, SOURCE.codUsuarioCreadorSistema,
SOURCE.fecCreacionSistema, SOURCE.codUsuarioUpdateSistema, SOURCE.fecUpdateSistema,
SOURCE.codUsuarioCreador, SOURCE.fecCreacion
);

COMMIT TRANSACTION;

SELECT @ProcessedRecords += COUNT(*) FROM #Batch WHERE BatchGroup = @BatchNumber;

IF @EnableLogging = 1
PRINT CONCAT('‚úÖ Sub-lote ', @BatchNumber, '/', @MaxBatchGroup, ' completado. Procesados: ', @ProcessedRecords);

SET @BatchNumber += 1;
IF @BatchNumber <= @MaxBatchGroup
WAITFOR DELAY '00:00:00.010';
END;

DROP TABLE #Batch;
TRUNCATE TABLE [convenio].[Mae_BeneficioEPS_Temp];

IF @EnableLogging = 1
PRINT 'üßπ Tabla Mae_BeneficioEPS_Temp limpiada con TRUNCATE.';

DECLARE @Duration INT = DATEDIFF(MILLISECOND, @StartTime, SYSDATETIME());

PRINT CONCAT('‚úÖ MERGE completado. Total: ', @TotalRecords, ', Tiempo: ', @Duration, ' ms, Promedio: ',
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END, ' ms/reg');

SELECT
@TotalRecords AS TotalRecords,
@ProcessedRecords AS ProcessedRecords,
@Duration AS DurationMs,
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END AS AvgMsPerRecord,
'SUCCESS' AS Status;

END TRY
BEGIN CATCH
IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
IF OBJECT_ID('tempdb..#Batch') IS NOT NULL DROP TABLE #Batch;

SET @ErrorMessage = CONCAT('‚ùå Error en sub-lote ', @BatchNumber, ': ', ERROR_MESSAGE(), ' (L√≠nea: ', ERROR_LINE(), ')');
PRINT @ErrorMessage;

IF OBJECT_ID('convenio.Mae_Log_Error_Merge') IS NOT NULL
BEGIN
INSERT INTO [convenio].[Mae_Log_Error_Merge] (
Procedimiento, TablaDestino, MensajeError, LineaError,
RegistrosProcesados, RegistrosTotales, Estado
)
VALUES (
'USP_PRO_DeltaBeneficioEPS', @TablaDestino, ERROR_MESSAGE(),
ERROR_LINE(), @ProcessedRecords, @TotalRecords, 'ERROR'
);
END

SELECT
@ProcessedRecords AS ProcessedRecords,
@TotalRecords AS TotalRecords,
@ErrorMessage AS ErrorMessage,
'ERROR' AS Status;

THROW;
END CATCH;
END;
[16:33, 30/5/2025] David üòé Arquitecto Pacifico: INSERT INTO [convenio].[Mae_BeneficioEPS_Temp] (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion
)
VALUES
('B001', 'BEN001', 'CB001', 'AMBULATORIO', 'S', 'N', 'S', 'N', 'PEAS', 'N', 101, 'S', 'SYS1', 'A', 'USR1', GETDATE(), NULL, NULL, 'USR1', GETDATE()),
('B002', 'BEN002', 'CB002', 'HOSPITALARIO', 'N', 'S', 'N', 'S', 'NOPEAS', 'S', 102, 'N', 'SYS1', 'A', 'USR2', GETDATE(), NULL, NULL, 'USR2', GETDATE());
[16:33, 30/5/2025] David üòé Arquitecto Pacifico: EXEC [convenio].[USP_PRO_DeltaBeneficioEPS]
@BatchSize = 100,
@EnableLogging = 1;        





‚úÖ 1. Usar SQL Server Profiler / Extended Events (si est√°s usando SSMS)
Aunque SQL Server Profiler no est√° directamente soportado para Azure SQL Database, puedes usar Extended Events para capturar la ejecuci√≥n de procedimientos.

Ejemplo b√°sico:
sql
Copiar
Editar
-- Crear una sesi√≥n de Extended Events para capturar ejecuciones de procedimientos almacenados
CREATE EVENT SESSION MonitorSPs
ON DATABASE
ADD EVENT sqlserver.sp_statement_completed
(
    ACTION (sqlserver.sql_text, sqlserver.client_hostname)
)
ADD TARGET package0.ring_buffer;
GO

-- Iniciar la sesi√≥n
ALTER EVENT SESSION MonitorSPs ON DATABASE STATE = START;
Para ver los resultados:
sql
Copiar
Editar
SELECT 
    event_data.value('(event/action[@name="sql_text"]/value)[1]', 'nvarchar(max)') AS sql_text,
    event_data.value('(event/@name)[1]', 'nvarchar(100)') AS event_name
FROM (
    SELECT CAST(event_data AS XML) AS event_data
    FROM sys.dm_xe_database_session_targets t
    JOIN sys.dm_xe_database_sessions s ON t.event_session_address = s.address
    WHERE s.name = 'MonitorSPs'
) AS data;
?????????????????????????????????????????????????????????



CREATE OR ALTER PROCEDURE [convenio].[USP_PRO_DeltaBeneficioEPS]
@BatchSize INT = 500,
@EnableLogging BIT = 0
AS
BEGIN
SET NOCOUNT ON;
SET XACT_ABORT ON;

DECLARE @TotalRecords INT;
DECLARE @ProcessedRecords INT = 0;
DECLARE @BatchNumber INT = 1;
DECLARE @StartTime DATETIME2 = SYSDATETIME();
DECLARE @ErrorMessage NVARCHAR(4000);
DECLARE @TablaDestino NVARCHAR(100) = 'Mae_BeneficioEPS';

SELECT @TotalRecords = COUNT(*) FROM [convenio].[Mae_BeneficioEPS_Temp] WHERE idBeneficioEps IS NOT NULL;

IF @EnableLogging = 1
PRINT CONCAT('üîÑ Iniciando MERGE de ', @TotalRecords, ' registros v√°lidos...');

IF EXISTS (
SELECT idBeneficioEps
FROM [convenio].[Mae_BeneficioEPS_Temp]
WHERE idBeneficioEps IS NOT NULL
GROUP BY idBeneficioEps
HAVING COUNT(*) > 1
)
BEGIN
RAISERROR('Error: Registros duplicados detectados en Mae_BeneficioEPS_Temp.', 16, 1);
RETURN;
END;

BEGIN TRY
CREATE TABLE #Batch (
idBeneficioEps NVARCHAR(100) NOT NULL,
idBeneficio NVARCHAR(100) NULL,
codBeneficio NVARCHAR(100) NULL,
tipoGastoPrestacion NVARCHAR(100) NULL,
indRequiereCartaGarantia NVARCHAR(10) NULL,
indBeneficioAdicional NVARCHAR(10) NULL,
indBeneficioPrincipal NVARCHAR(10) NULL,
indProcEspeciales NVARCHAR(10) NULL,
tipoPEAS NVARCHAR(50) NULL,
indBeneficioComun NVARCHAR(10) NULL,
codGrupoServicio INT NULL,
indMostrarCG NVARCHAR(10) NULL,
codSistema NVARCHAR(50) NULL,
estRegistro NVARCHAR(10) NULL,
codUsuarioCreadorSistema NVARCHAR(100) NULL,
fecCreacionSistema DATETIME NULL,
codUsuarioUpdateSistema NVARCHAR(100) NULL,
fecUpdateSistema DATETIME NULL,
codUsuarioCreador NVARCHAR(100) NULL,
fecCreacion DATETIME NULL,
BatchGroup INT NOT NULL,
PRIMARY KEY CLUSTERED (BatchGroup, idBeneficioEps)
);

INSERT INTO #Batch (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion, BatchGroup
)
SELECT
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion,
((ROW_NUMBER() OVER (ORDER BY idBeneficioEps) - 1) / @BatchSize) + 1
FROM [convenio].[Mae_BeneficioEPS_Temp]
WHERE idBeneficioEps IS NOT NULL;

DECLARE @MaxBatchGroup INT;
SELECT @MaxBatchGroup = MAX(BatchGroup) FROM #Batch;

WHILE @BatchNumber <= @MaxBatchGroup
BEGIN
BEGIN TRANSACTION;

MERGE [convenio].[Mae_BeneficioEPS] AS TARGET
USING (
SELECT * FROM #Batch WHERE BatchGroup = @BatchNumber
) AS SOURCE
ON TARGET.idBeneficioEps = SOURCE.idBeneficioEps

WHEN MATCHED AND (
ISNULL(TARGET.idBeneficio,'') != ISNULL(SOURCE.idBeneficio,'') OR
ISNULL(TARGET.codBeneficio,'') != ISNULL(SOURCE.codBeneficio,'') OR
ISNULL(TARGET.tipoGastoPrestacion,'') != ISNULL(SOURCE.tipoGastoPrestacion,'') OR
ISNULL(TARGET.indRequiereCartaGarantia,'') != ISNULL(SOURCE.indRequiereCartaGarantia,'') OR
ISNULL(TARGET.indBeneficioAdicional,'') != ISNULL(SOURCE.indBeneficioAdicional,'') OR
ISNULL(TARGET.indBeneficioPrincipal,'') != ISNULL(SOURCE.indBeneficioPrincipal,'') OR
ISNULL(TARGET.indProcEspeciales,'') != ISNULL(SOURCE.indProcEspeciales,'') OR
ISNULL(TARGET.tipoPEAS,'') != ISNULL(SOURCE.tipoPEAS,'') OR
ISNULL(TARGET.indBeneficioComun,'') != ISNULL(SOURCE.indBeneficioComun,'') OR
ISNULL(TARGET.codGrupoServicio, -1) != ISNULL(SOURCE.codGrupoServicio, -1) OR
ISNULL(TARGET.indMostrarCG,'') != ISNULL(SOURCE.indMostrarCG,'') OR
ISNULL(TARGET.codSistema,'') != ISNULL(SOURCE.codSistema,'') OR
ISNULL(TARGET.estRegistro,'') != ISNULL(SOURCE.estRegistro,'') OR
ISNULL(TARGET.codUsuarioCreadorSistema,'') != ISNULL(SOURCE.codUsuarioCreadorSistema,'') OR
ISNULL(TARGET.fecCreacionSistema,'1900-01-01') != ISNULL(SOURCE.fecCreacionSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioUpdateSistema,'') != ISNULL(SOURCE.codUsuarioUpdateSistema,'') OR
ISNULL(TARGET.fecUpdateSistema,'1900-01-01') != ISNULL(SOURCE.fecUpdateSistema,'1900-01-01') OR
ISNULL(TARGET.codUsuarioCreador,'') != ISNULL(SOURCE.codUsuarioCreador,'') OR
ISNULL(TARGET.fecCreacion,'1900-01-01') != ISNULL(SOURCE.fecCreacion,'1900-01-01')
) THEN
UPDATE SET
TARGET.idBeneficio = SOURCE.idBeneficio,
TARGET.codBeneficio = SOURCE.codBeneficio,
TARGET.tipoGastoPrestacion = SOURCE.tipoGastoPrestacion,
TARGET.indRequiereCartaGarantia = SOURCE.indRequiereCartaGarantia,
TARGET.indBeneficioAdicional = SOURCE.indBeneficioAdicional,
TARGET.indBeneficioPrincipal = SOURCE.indBeneficioPrincipal,
TARGET.indProcEspeciales = SOURCE.indProcEspeciales,
TARGET.tipoPEAS = SOURCE.tipoPEAS,
TARGET.indBeneficioComun = SOURCE.indBeneficioComun,
TARGET.codGrupoServicio = SOURCE.codGrupoServicio,
TARGET.indMostrarCG = SOURCE.indMostrarCG,
TARGET.codSistema = SOURCE.codSistema,
TARGET.estRegistro = SOURCE.estRegistro,
TARGET.codUsuarioCreadorSistema = SOURCE.codUsuarioCreadorSistema,
TARGET.fecCreacionSistema = SOURCE.fecCreacionSistema,
TARGET.codUsuarioUpdateSistema = SOURCE.codUsuarioUpdateSistema,
TARGET.fecUpdateSistema = SOURCE.fecUpdateSistema,
TARGET.codUsuarioCreador = SOURCE.codUsuarioCreador,
TARGET.fecCreacion = SOURCE.fecCreacion

WHEN NOT MATCHED BY TARGET THEN
INSERT (
idBeneficioEps, idBeneficio, codBeneficio, tipoGastoPrestacion,
indRequiereCartaGarantia, indBeneficioAdicional, indBeneficioPrincipal,
indProcEspeciales, tipoPEAS, indBeneficioComun, codGrupoServicio,
indMostrarCG, codSistema, estRegistro, codUsuarioCreadorSistema,
fecCreacionSistema, codUsuarioUpdateSistema, fecUpdateSistema,
codUsuarioCreador, fecCreacion
)
VALUES (
SOURCE.idBeneficioEps, SOURCE.idBeneficio, SOURCE.codBeneficio, SOURCE.tipoGastoPrestacion,
SOURCE.indRequiereCartaGarantia, SOURCE.indBeneficioAdicional, SOURCE.indBeneficioPrincipal,
SOURCE.indProcEspeciales, SOURCE.tipoPEAS, SOURCE.indBeneficioComun, SOURCE.codGrupoServicio,
SOURCE.indMostrarCG, SOURCE.codSistema, SOURCE.estRegistro, SOURCE.codUsuarioCreadorSistema,
SOURCE.fecCreacionSistema, SOURCE.codUsuarioUpdateSistema, SOURCE.fecUpdateSistema,
SOURCE.codUsuarioCreador, SOURCE.fecCreacion
);

COMMIT TRANSACTION;

SELECT @ProcessedRecords += COUNT(*) FROM #Batch WHERE BatchGroup = @BatchNumber;

IF @EnableLogging = 1
PRINT CONCAT('‚úÖ Sub-lote ', @BatchNumber, '/', @MaxBatchGroup, ' completado. Procesados: ', @ProcessedRecords);

SET @BatchNumber += 1;
IF @BatchNumber <= @MaxBatchGroup
WAITFOR DELAY '00:00:00.010';
END;

DROP TABLE #Batch;
TRUNCATE TABLE [convenio].[Mae_BeneficioEPS_Temp];

IF @EnableLogging = 1
PRINT 'üßπ Tabla Mae_BeneficioEPS_Temp limpiada con TRUNCATE.';

DECLARE @Duration INT = DATEDIFF(MILLISECOND, @StartTime, SYSDATETIME());

PRINT CONCAT('‚úÖ MERGE completado. Total: ', @TotalRecords, ', Tiempo: ', @Duration, ' ms, Promedio: ',
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END, ' ms/reg');

SELECT
@TotalRecords AS TotalRecords,
@ProcessedRecords AS ProcessedRecords,
@Duration AS DurationMs,
CASE WHEN @TotalRecords > 0 THEN @Duration / @TotalRecords ELSE 0 END AS AvgMsPerRecord,
'SUCCESS' AS Status;

END TRY
BEGIN CATCH
IF @@TRANCOUNT > 0 ROLLBACK TRANSACTION;
IF OBJECT_ID('tempdb..#Batch') IS NOT NULL DROP TABLE #Batch;

SET @ErrorMessage = CONCAT('‚ùå Error en sub-lote ', @BatchNumber, ': ', ERROR_MESSAGE(), ' (L√≠nea: ', ERROR_LINE(), ')');
PRINT @ErrorMessage;

IF OBJECT_ID('convenio.Mae_Log_Error_Merge') IS NOT NULL
BEGIN
INSERT INTO [convenio].[Mae_Log_Error_Merge] (
Procedimiento, TablaDestino, MensajeError, LineaError,
RegistrosProcesados, RegistrosTotales, Estado
)
VALUES (
'USP_PRO_DeltaBeneficioEPS', @TablaDestino, ERROR_MESSAGE(),
ERROR_LINE(), @ProcessedRecords, @TotalRecords, 'ERROR'
);
END

SELECT
@ProcessedRecords AS ProcessedRecords,
@TotalRecords AS TotalRecords,
@ErrorMessage AS ErrorMessage,
'ERROR' AS Status;

THROW;
END CATCH;
END;

e>\r\n\r\n                  </td>\r\n               </tr>\r\n            </table>\r\n\r\n            
<br>\r\n\r\n            <b>Notes:</b> The current error page you are seeing can be replaced by a custom error page by modifying the &quot;defaultRedirect&quot; attribute of the application&#39;s &lt;customErrors&gt; configuration tag to point to a custom error page URL.<br><br>\r\n\r\n            <table width=100% bgcolor=\"#ffffcc\">\r\n               <tr>\r\n                  <td>\r\n               
       <code><pre>\r\n\r\n&lt;!-- Web.Config Configuration File --&gt;\r\n\r\n&lt;configuration&gt;\r\n    &lt;system.web&gt;\r\n        &lt;customErrors mode=&quot;RemoteOnly&quot; defaultRedirect=&quot;mycustompage.htm&quot;/&gt;\r\n    &lt;/system.web&gt;\r\n&lt;/configuration&gt;</pre>             
         </code>\r\n\r\n                  </td>\r\n               </tr>\r\n            </table>\r\n\r\n            <br>\r\n\r\n            </font>\r\n\r\n    </body>\r\n</html>\r\n","stack":"RestError: <!DOCTYPE html>\r\n<html>\r\n    <head>\r\n        <title>Runtime Error</title>\r\n        <meta name=\"viewport\" content=\"width=device-width\" />\r\n        <style>\r\n         body {font-family:\"Verdana\";font-weight:normal;font-size: .7em;color:black;} \r\n         p {font-family:\"Verdana\";font-weight:normal;color:black;margin-top: -5px}\r\n         b {font-family:\"Verdana\";font-weight:bold;color:black;margin-top: -5px}\r\n         H1 { font-family:\"Verdana\";font-weight:normal;font-size:18pt;color:red }\r\n         H2 { font-family:\"Verdana\";font-weight:normal;font-size:14pt;color:maroon }\r\n         pre {font-family:\"Consolas\",\"Lucida Console\",Monospace;font-size:11pt;margin:0;padding:0.5em;line-height:14pt}\r\n         .marker {font-weight: bold; color: black;text-decoration: none;}\r\n         .version {color: gray;}\r\n         .error {margin-bottom: 10px;}\r\n         .expandable { text-decoration:underline; font-weight:bold; color:navy; cursor:pointer; }\r\n         @media screen and (max-width: 639px) {\r\n          pre { width: 440px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; }\r\n         }\r\n         @media screen and (max-width: 479px) {\r\n          pre { width: 280px; }\r\n         }\r\n        </style>\r\n    </head>\r\n\r\n    <body bgcolor=\"white\">\r\n\r\n            <span><H1>Server Error in '/' Application.<hr width=100% size=1 color=silver></H1>\r\n\r\n            <h2> <i>Runtime Error</i> </h2></span>\r\n\r\n            <font face=\"Arial, Helvetica, Geneva, SunSans-Regular, sans-serif \">\r\n\r\n            <b> Description: </b>An application error occurred on the server. The current custom error settings for this application prevent the details of the application error from being viewed remotely (for security reasons). It could, however, be viewed by browsers running on the local server machine.\r\n            <br><br>\r\n\r\n            <b>Details:</b> To enable the details of this specific error message to be viewable on remote machines, please create a &lt;customErrors&gt; tag within a &quot;web.config&quot; configuration file located in the root directory of the current web application. This &lt;customErrors&gt; tag should then have its &quot;mode&quot; attribute set to &quot;Off&quot;.<br><br>\r\n\r\n            <table width=100% bgcolor=\"#ffffcc\">\r\n               <tr>\r\n                  <td>\r\n            
          <code><pre>\r\n\r\n&lt;!-- Web.Config Configuration File --&gt;\r\n\r\n&lt;configuration&gt;\r\n    &lt;system.web&gt;\r\n        &lt;customErrors mode=&quot;Off&quot;/&gt;\r\n    &lt;/system.web&gt;\r\n&lt;/configuration&gt;</pre>                      </code>\r\n\r\n                  </td>\r\n               </tr>\r\n            </table>\r\n\r\n            <br>\r\n\r\n            <b>Notes:</b> The current error page you are seeing can be replaced by a custom error page by modifying the &quot;defaultRedirect&quot; attribute of the application&#39;s &lt;customErrors&gt; configuration tag to point to a custom error page URL.<br><br>\r\n\r\n            <table width=100% bgcolor=\"#ffffcc\">\r\n               <tr>\r\n                  <td>\r\n                      <code><pre>\r\n\r\n&lt;!-- Web.Config Configuration File --&gt;\r\n\r\n&lt;configuration&gt;\r\n    &lt;system.web&gt;\r\n        &lt;customErrors mode=&quot;RemoteOnly&quot; defaultRedirect=&quot;mycustompage.htm&quot;/&gt;\r\n  
  &lt;/system.web&gt;\r\n&lt;/configuration&gt;</pre>                      </code>\r\n\r\n           
       </td>\r\n               </tr>\r\n            </table>\r\n\r\n            <br>\r\n\r\n         
   </font>\r\n\r\n    </body>\r\n</html>\r\n\n    at handleErrorResponse (C:\\Users\\ext.jbecerrak.softte\\Desktop\\srv-ms-sm-ne-ods-consultaProveedor\\ne-ods-consultaProveedor\\node_modules\\@azure\\core-client\\src\\deserializationPolicy.ts:255:17)\n    at deserializeResponseBody (C:\\Users\\ext.jbecerrak.softte\\Desktop\\srv-ms-sm-ne-ods-consultaProveedor\\ne-ods-consultaProveedor\\node_modules\\@azure\\core-client\\src\\deserializationPolicy.ts:159:43)\n    at process.processTicksAndRejections (node:internal/process/task_queues:95:5)","name":"RestError","statusCode":400,"details":{}},"msg":"<!DOCTYPE html>\r\n<html>\r\n    <head>\r\n        <title>Runtime Error</title>\r\n        <meta name=\"viewport\" content=\"width=device-width\" />\r\n        <style>\r\n         body {font-family:\"Verdana\";font-weight:normal;font-size: .7em;color:black;} \r\n         p {font-family:\"Verdana\";font-weight:normal;color:black;margin-top: -5px}\r\n         b {font-family:\"Verdana\";font-weight:bold;color:black;margin-top: -5px}\r\n         H1 { font-family:\"Verdana\";font-weight:normal;font-size:18pt;color:red }\r\n         H2 { font-family:\"Verdana\";font-weight:normal;font-size:14pt;color:maroon }\r\n         pre {font-family:\"Consolas\",\"Lucida Console\",Monospace;font-size:11pt;margin:0;padding:0.5em;line-height:14pt}\r\n         .marker {font-weight: bold; color: black;text-decoration: none;}\r\n         .version {color: gray;}\r\n         .error {margin-bottom: 10px;}\r\n         .expandable { text-decoration:underline; font-weight:bold; color:navy; cursor:pointer; }\r\n         @media screen and (max-width: 639px) {\r\n          pre { width: 440px; overflow: auto; white-space: pre-wrap; word-wrap: break-word; }\r\n         }\r\n         @media screen and (max-width: 479px) {\r\n          pre { width: 280px; }\r\n         }\r\n        </style>\r\n    </head>\r\n\r\n    <body bgcolor=\"white\">\r\n\r\n            <span><H1>Server Error in '/' Application.<hr width=100% size=1 color=silver></H1>\r\n\r\n            <h2> <i>Runtime Error</i> </h2></span>\r\n\r\n            <font face=\"Arial, Helvetica, Geneva, SunSans-Regular, sans-serif \">\r\n\r\n            <b> Description: </b>An application error occurred on the server. The current custom error settings for this application prevent the details of the application error from being viewed remotely (for security reasons). It could, however, be viewed by browsers running on the local server machine.\r\n            <br><br>\r\n\r\n            <b>Details:</b> To enable the details of this specific error message to be viewable on remote machines, please create a &lt;customErrors&gt; tag within a &quot;web.config&quot; configuration file located in the root directory of the current web application. This &lt;customErrors&gt; tag should then have its &quot;mode&quot; attribute set to &quot;Off&quot;.<br><br>\r\n\r\n            <table width=100% bgcolor=\"#ffffcc\">\r\n               <tr>\r\n                  <td>\r\n                
      <code><pre>\r\n\r\n&lt;!-- Web.Config Configuration File --&gt;\r\n\r\n&lt;configuration&gt;\r\n    &lt;system.web&gt;\r\n        &lt;customErrors mode=&quot;Off&quot;/&gt;\r\n    &lt;/system.web&gt;\r\n&lt;/configuration&gt;</pre>                      </code>\r\n\r\n                  </td>\r\n               </tr>\r\n            </table>\r\n\r\n            <br>\r\n\r\n            <b>Notes:</b> The current error page you are seeing can be replaced by a custom error page by modifying the &quot;defaultRedirect&quot; attribute of the application&#39;s &lt;customErrors&gt; configuration tag to point to a custom error page URL.<br><br>\r\n\r\n            <table width=100% bgcolor=\"#ffffcc\">\r\n               <tr>\r\n                  <td>\r\n                      <code><pre>\r\n\r\n&lt;!-- Web.Config Configuration File --&gt;\r\n\r\n&lt;configuration&gt;\r\n    &lt;system.web&gt;\r\n        &lt;customErrors mode=&quot;RemoteOnly&quot; defaultRedirect=&quot;mycustompage.htm&quot;/&gt;\r\n    &lt;/system.web&gt;\r\n&lt;/configuration&gt;</pre>                      </code>\r\n\r\n               
   </td>\r\n               </tr>\r\n            </table>\r\n\r\n            <br>\r\n\r\n            </font>\r\n\r\n    </body>\r\n</html>\r\n"}
{"level":50,"time":1748886255522,"pid":16224,"hostname":"vme1dessftvm02","context":"application insights","msg":"Application Insights is not initialized. Cannot track exception."}
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorController] [INICIO buscarProveedores] X-Correlation-Id: 1, X-Request-Id: 1
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorController] Aplicaci√≥n: 1, Proceso: 1, Usuario: 11
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorController] Criterios de b√∫squeda: {"pageSize":20,"pageStartIndex":0}
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorSearchService] [INICIO searchProveedores] Filtros: {"pageSize":20,"pageStartIndex":0}
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorSearchService] Query generada: SELECT "p"."idProveedor" AS "p_idProveedor", "p"."idPersona" AS "p_idPersona", "p"."idTipoProveedor" AS "p_idTipoProveedor", "p"."codigoProveedor" AS "p_codigoProveedor", "p"."tipoProveedor" AS "p_tipoProveedor", "p"."indicadorCertificacion" AS "p_indicadorCertificacion", "p"."indicadorRedSelecta" AS "p_indicadorRedSelecta", "p"."estadoRegistro" AS "p_estadoRegistro", "p"."codigoUsuarioCreador" AS "p_codigoUsuarioCreador", "p"."fechaCreacion" AS "p_fechaCreacion", "p"."codigoUsuarioModificador" AS "p_codigoUsuarioModificador", "p"."fechaModificacion" AS "p_fechaModificacion", "tp"."IdTipoProveedor" AS "tp_IdTipoProveedor", "tp"."TipoProveedor" AS "tp_TipoProveedor", "tp"."DescripcionTipoProveedor" AS "tp_DescripcionTipoProveedor", "tp"."EstadoRegistro" AS "tp_EstadoRegistro", "tp"."CodigoUsuarioCreador" AS "tp_CodigoUsuarioCreador", "tp"."FechaCreacion" AS "tp_FechaCreacion", "tp"."CodigoUsuarioModificador" AS "tp_CodigoUsuarioModificador", "tp"."FechaModificacion" AS "tp_FechaModificacion", "tp"."CodigoUsuarioCreadorSistema" AS "tp_CodigoUsuarioCreadorSistema", "tp"."FechaCreacionSistema" AS "tp_FechaCreacionSistema", "tp"."CodigoUsuarioUpdateSistema" AS "tp_CodigoUsuarioUpdateSistema", "tp"."FechaUpdateSistema" AS "tp_FechaUpdateSistema" FROM "persona"."Mae_Proveedor" "p" LEFT JOIN "persona"."Tip_TipoProveedor" "tp" ON "tp"."IdTipoProveedor"="p"."idTipoProveedor"  LEFT JOIN "persona"."Mae_Persona" "persona" ON "persona"."IdPersona"="p"."idPersona"
query: SELECT COUNT(DISTINCT("p"."idProveedor")) AS "cnt" FROM "persona"."Mae_Proveedor" "p" LEFT JOIN "persona"."Tip_TipoProveedor" "tp" ON "tp"."IdTipoProveedor"="p"."idTipoProveedor"  LEFT JOIN "persona"."Mae_Persona" "persona" ON "persona"."IdPersona"="p"."idPersona"
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorSearchService] Total de elementos encontrados: 3
query: SELECT DISTINCT "distinctAlias"."p_idProveedor" AS "ids_p_idProveedor", "distinctAlias"."p_codigoProveedor" FROM (SELECT "p"."idProveedor" AS "p_idProveedor", "p"."idPersona" AS "p_idPersona", "p"."idTipoProveedor" AS "p_idTipoProveedor", "p"."codigoProveedor" AS "p_codigoProveedor", "p"."tipoProveedor" AS "p_tipoProveedor", "p"."indicadorCertificacion" AS "p_indicadorCertificacion", "p"."indicadorRedSelecta" AS "p_indicadorRedSelecta", "p"."estadoRegistro" AS "p_estadoRegistro", "p"."codigoUsuarioCreador" AS "p_codigoUsuarioCreador", "p"."fechaCreacion" AS "p_fechaCreacion", "p"."codigoUsuarioModificador" AS "p_codigoUsuarioModificador", "p"."fechaModificacion" AS "p_fechaModificacion", "tp"."IdTipoProveedor" AS "tp_IdTipoProveedor", "tp"."TipoProveedor" AS "tp_TipoProveedor", "tp"."DescripcionTipoProveedor" AS "tp_DescripcionTipoProveedor", "tp"."EstadoRegistro" AS "tp_EstadoRegistro", "tp"."CodigoUsuarioCreador" AS "tp_CodigoUsuarioCreador", "tp"."FechaCreacion" AS "tp_FechaCreacion", "tp"."CodigoUsuarioModificador" AS "tp_CodigoUsuarioModificador", "tp"."FechaModificacion" AS "tp_FechaModificacion", "tp"."CodigoUsuarioCreadorSistema" AS "tp_CodigoUsuarioCreadorSistema", "tp"."FechaCreacionSistema" AS "tp_FechaCreacionSistema", "tp"."CodigoUsuarioUpdateSistema" AS "tp_CodigoUsuarioUpdateSistema", "tp"."FechaUpdateSistema" AS "tp_FechaUpdateSistema" FROM "persona"."Mae_Proveedor" "p" LEFT JOIN "persona"."Tip_TipoProveedor" "tp" ON "tp"."IdTipoProveedor"="p"."idTipoProveedor"  LEFT JOIN "persona"."Mae_Persona" "persona" ON "persona"."IdPersona"="p"."idPersona") "distinctAlias" ORDER BY "distinctAlias"."p_codigoProveedor" ASC, "p_idProveedor" ASC OFFSET 0 ROWS FETCH NEXT 20 ROWS ONLY
query: SELECT "p"."idProveedor" AS "p_idProveedor", "p"."idPersona" AS "p_idPersona", "p"."idTipoProveedor" AS "p_idTipoProveedor", "p"."codigoProveedor" AS "p_codigoProveedor", "p"."tipoProveedor" AS "p_tipoProveedor", "p"."indicadorCertificacion" AS "p_indicadorCertificacion", "p"."indicadorRedSelecta" AS "p_indicadorRedSelecta", "p"."estadoRegistro" AS "p_estadoRegistro", "p"."codigoUsuarioCreador" AS "p_codigoUsuarioCreador", "p"."fechaCreacion" AS "p_fechaCreacion", "p"."codigoUsuarioModificador" AS "p_codigoUsuarioModificador", "p"."fechaModificacion" AS "p_fechaModificacion", "tp"."IdTipoProveedor" AS "tp_IdTipoProveedor", "tp"."TipoProveedor" AS "tp_TipoProveedor", "tp"."DescripcionTipoProveedor" AS "tp_DescripcionTipoProveedor", "tp"."EstadoRegistro" AS "tp_EstadoRegistro", "tp"."CodigoUsuarioCreador" AS "tp_CodigoUsuarioCreador", "tp"."FechaCreacion" AS "tp_FechaCreacion", "tp"."CodigoUsuarioModificador" AS "tp_CodigoUsuarioModificador", "tp"."FechaModificacion" AS "tp_FechaModificacion", "tp"."CodigoUsuarioCreadorSistema" AS "tp_CodigoUsuarioCreadorSistema", "tp"."FechaCreacionSistema" AS "tp_FechaCreacionSistema", "tp"."CodigoUsuarioUpdateSistema" AS "tp_CodigoUsuarioUpdateSistema", "tp"."FechaUpdateSistema" AS "tp_FechaUpdateSistema" FROM "persona"."Mae_Proveedor" "p" LEFT JOIN "persona"."Tip_TipoProveedor" "tp" ON "tp"."IdTipoProveedor"="p"."idTipoProveedor"  LEFT JOIN "persona"."Mae_Persona" "persona" ON "persona"."IdPersona"="p"."idPersona" WHERE "p"."idProveedor" IN (@0, @1, @2) ORDER BY "p"."codigoProveedor" ASC -- PARAMETERS: ["4ED8392B-0C66-4581-B7A0-BF43D6970F98","5F9F7C59-57EF-45BF-9C50-19DDDA840BC0","8A12AF06-D578-424D-B6FF-70FC4E537364"]
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorSearchService] IDs de proveedores encontrados: 4ED8392B-0C66-4581-B7A0-BF43D6970F98, 5F9F7C59-57EF-45BF-9C50-19DDDA840BC0, 8A12AF06-D578-424D-B6FF-70FC4E537364
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorSearchService] C√≥digos de proveedores encontrados: 10001, 10002, 10003
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorSearchService] [FIN searchProveedores] Tiempo total: 165ms, Proveedores encontrados: 3      
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorController] [FIN buscarProveedores] X-Correlation-Id: 1, Tiempo total: 167ms
[Nest] 16224  - 06/02/2025, 12:44:25 PM     LOG [ProveedorController] Proveedores encontrados: 3
{"level":30,"time":1748886265996,"pid":16224,"hostname":"vme1dessftvm02","req":{"method":"POST","url":"/ms-ne-consulta-personaProveedor-eps/persona/v1.0.0/proveedor","X-Correlation-Id":"1","X-Request-Id":"1","usuarioAplicacion":"11","nombreAplicacion":"1","procesoNegocio":"1"},"res":{"statusCode":201},"responseTime":191,"msg":"request completed"}
^C^C^CTerminate batch job (Y/N)? 
^C
PS C:\Users\ext.jbecerrak.softte\Desktop\srv-ms-sm-ne-ods
