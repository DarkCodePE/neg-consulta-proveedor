curl --location 'https://apim-eu1-border-service-desa.azure-api.net/ot-configServer/config/srv-ms-sm-ne-ods-consultaProveedor/development?files=application.yml' \

--header 'x-api-key: df584e6f4dcc46e183a100d16da13c54' \

--header 'ocp-apim-subscription-key: df584e6f4dcc46e183a100d16da13c54' \

--data ''
 
-- =====================================================
-- SCRIPT PARA RECREAR TODAS LAS TABLAS CON ULID
-- Y TIP_ROL CON IDTIPOROL VARCHAR(50)
-- =====================================================

-- =====================================================
-- PASO 1: ELIMINAR TODAS LAS TABLAS EXISTENTES
-- (En orden correcto respetando Foreign Keys)
-- =====================================================

-- Eliminar tablas de relación primero
DROP TABLE IF EXISTS Mae_SucursalCompaniaSeguro;
DROP TABLE IF EXISTS Tbt_PersonaCompaniaSeguro;
DROP TABLE IF EXISTS Tbt_PersonaRol;
DROP TABLE IF EXISTS Mae_Sucursal;
DROP TABLE IF EXISTS Mae_Proveedor;

-- Eliminar tablas de catálogo
DROP TABLE IF EXISTS Mae_CompaniaSeguros;
DROP TABLE IF EXISTS Mae_PersonaJuridica;
DROP TABLE IF EXISTS Tip_TipoProveedor;
DROP TABLE IF EXISTS Tip_Rol;

-- Eliminar tabla base
DROP TABLE IF EXISTS Mae_Persona;

-- =====================================================
-- PASO 2: RECREAR TABLAS CON ULID (VARCHAR(26))
-- =====================================================

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- TABLA BASE: Mae_Persona
CREATE TABLE Mae_Persona
(
    IdPersona                    VARCHAR(26)         NOT NULL    CONSTRAINT PK_Mae_Persona PRIMARY KEY,
    TipoPersona                  CHAR(1)             NOT NULL,   -- J: Jurídica, N: Natural
    NombreCompletoPersona        NVARCHAR(200)       NOT NULL,
    NombreAbreviadoPersona       NVARCHAR(100)       NOT NULL,
    CodigoTipoDocumento          VARCHAR(20)         NOT NULL,
    NumeroDocumento              VARCHAR(20)         NOT NULL,
    DescripcionPaginaWeb         NVARCHAR(100)       NULL,
    CodigoTipoTrabajador         CHAR(1)             NULL,
    EstadoRegistro               CHAR(3)             NOT NULL,   -- V: Vigente, A: Anulado
    FechaCreacion                DATETIME            NOT NULL,
    CodigoUsuarioCreador         VARCHAR(15)         NOT NULL,
    FechaModificacion            DATETIME            NULL,
    CodigoUsuarioModificador     VARCHAR(15)         NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema  VARCHAR(15)         NOT NULL,
    FechaCreacionSistema         DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema   VARCHAR(15)         NULL,
    FechaUpdateSistema           DATETIME            NULL
);
GO

-- TABLA: Mae_PersonaJuridica
CREATE TABLE Mae_PersonaJuridica
(
    IdPersona                      VARCHAR(26)         NOT NULL    CONSTRAINT PK_Mae_PersonaJuridica PRIMARY KEY
        CONSTRAINT FK_Mae_PersonaJuridica_Mae_Persona REFERENCES Mae_Persona,
    FechaAniversario               DATE                NULL,
    NombreRazonSocial              VARCHAR(70)         NOT NULL,
    NombreRazonSocialAbreviada     VARCHAR(50)         NULL,
    CodigoGrupoEconomico           VARCHAR(6)          NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Mae_CompaniaSeguros
CREATE TABLE Mae_CompaniaSeguros
(
    IdCompaniaSeguros              VARCHAR(26)         NOT NULL    CONSTRAINT PK_Mae_CompaniaSeguros PRIMARY KEY,
    IdPersonaJuridica              VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Mae_CompaniaSeguros_Mae_PersonaJuridica REFERENCES Mae_PersonaJuridica,
    CodigoIAFA                     VARCHAR(5)          NOT NULL,
    DescripcionCompaniaSeguros     VARCHAR(40)         NOT NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Tip_Rol (CON IDTIPOROL VARCHAR(50))
CREATE TABLE Tip_Rol
(
    IdTipoRol                      VARCHAR(50)         NOT NULL    CONSTRAINT PK_Tip_Rol PRIMARY KEY,
    CodigoLval                     VARCHAR(15)         NULL,
    DescripcionRol                 VARCHAR(50)         NOT NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Tip_TipoProveedor
CREATE TABLE Tip_TipoProveedor
(
    IdTipoProveedor                VARCHAR(26)         NOT NULL    CONSTRAINT PK_Tip_TipoProveedor PRIMARY KEY,
    TipoProveedor                  NUMERIC(2,0)        NOT NULL,
    DescripcionTipoProveedor       VARCHAR(150)        NOT NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Mae_Proveedor
CREATE TABLE Mae_Proveedor
(
    IdProveedor                    VARCHAR(26)         NOT NULL    CONSTRAINT PK_Mae_Proveedor PRIMARY KEY,
    IdPersona                      VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Mae_Proveedor_Mae_Persona REFERENCES Mae_Persona,
    IdTipoProveedor                VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Mae_Proveedor_Tip_TipoProveedor REFERENCES Tip_TipoProveedor,
    CodigoProveedor                VARCHAR(10)         NOT NULL,
    TipoProveedor                  NUMERIC(2,0)        NOT NULL,
    IndicadorCertificacion         VARCHAR(1)          NULL,
    IndicadorRedSelecta            VARCHAR(1)          NOT NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Mae_Sucursal
CREATE TABLE Mae_Sucursal
(
    IdSucursal                     VARCHAR(26)         NOT NULL    CONSTRAINT PK_Mae_Sucursal PRIMARY KEY,
    IdProveedor                    VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Mae_Sucursal_Mae_Proveedor REFERENCES Mae_Proveedor,
    CodigoProveedor                VARCHAR(10)         NOT NULL,
    NumeroSucursalProveedor        VARCHAR(4)          NOT NULL,
    DescripcionSucursal            VARCHAR(150)        NOT NULL,
    IndicadorPrincipalSucursal     VARCHAR(1)          NOT NULL,
    CategoriaSucursal              CHAR(1)             NULL,
    CodigoSucursalSeps             VARCHAR(10)         NULL,
    RegistroSeps                   VARCHAR(10)         NULL,
    IndicadorEPS                   VARCHAR(1)          NULL,
    CodigoSeps                     VARCHAR(20)         NULL,
    CodigoClinicaEps               VARCHAR(20)         NULL,
    IndicadorRedSelecta            CHAR(1)             NULL,
    IndicadorExoneracionIgv        VARCHAR(1)          NULL,
    IndicadorDetraccion            VARCHAR(1)          NULL,
    TipoInstitucion                VARCHAR(20)         NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Tbt_PersonaRol
CREATE TABLE Tbt_PersonaRol
(
    IdPersonaRol                   VARCHAR(26)         NOT NULL    CONSTRAINT PK_Tbt_PersonaRol PRIMARY KEY,
    IdPersona                      VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Tbt_PersonaRol_Mae_Persona REFERENCES Mae_Persona,
    IdTipoRol                      VARCHAR(50)         NOT NULL    
        CONSTRAINT FK_Tbt_PersonaRol_Tip_Rol REFERENCES Tip_Rol,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Tbt_PersonaCompaniaSeguro
CREATE TABLE Tbt_PersonaCompaniaSeguro
(
    IdPersonaCompaniaSeguro        VARCHAR(26)         NOT NULL    CONSTRAINT PK_Tbt_PersonaCompaniaSeguro PRIMARY KEY,
    IdPersona                      VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Tbt_PersonaCompaniaSeguro_Mae_Persona REFERENCES Mae_Persona,
    IdCompaniaSeguro               VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Tbt_PersonaCompaniaSeguro_Mae_CompaniaSeguros REFERENCES Mae_CompaniaSeguros,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- TABLA: Mae_SucursalCompaniaSeguro
CREATE TABLE Mae_SucursalCompaniaSeguro
(
    IdSucursalCompaniaSeguro       VARCHAR(26)         NOT NULL    CONSTRAINT PK_Mae_SucursalCompaniaSeguro PRIMARY KEY,
    IdSucursal                     VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Mae_SucursalCompaniaSeguro_Mae_Sucursal REFERENCES Mae_Sucursal,
    IdCompaniaSeguro               VARCHAR(26)         NOT NULL    
        CONSTRAINT FK_Mae_SucursalCompaniaSeguro_Mae_CompaniaSeguros REFERENCES Mae_CompaniaSeguros,
    CodigoProveedor                VARCHAR(10)         NOT NULL,
    NumeroSucursalProveedor        VARCHAR(10)         NOT NULL,
    EstadoRegistro                 CHAR(1)             NOT NULL,   -- V: Vigente, A: Anulado
    CodigoUsuarioCreador           VARCHAR(15)         NOT NULL,
    FechaCreacion                  DATETIME            NOT NULL,
    CodigoUsuarioModificador       VARCHAR(15)         NULL,
    FechaModificacion              DATETIME            NULL,
    -- Campos de auditoría adicionales
    CodigoUsuarioCreadorSistema    VARCHAR(15)         NOT NULL,
    FechaCreacionSistema           DATETIME            NOT NULL,
    CodigoUsuarioUpdateSistema     VARCHAR(15)         NULL,
    FechaUpdateSistema             DATETIME            NULL
);
GO

-- =====================================================
-- PASO 3: CREAR ÍNDICES PARA OPTIMIZAR BÚSQUEDAS
-- =====================================================
CREATE NONCLUSTERED INDEX IX_Mae_Persona_01 ON Mae_Persona(NumeroDocumento, CodigoTipoDocumento);
CREATE NONCLUSTERED INDEX IX_Mae_Proveedor_01 ON Mae_Proveedor(CodigoProveedor);
CREATE NONCLUSTERED INDEX IX_Mae_Sucursal_01 ON Mae_Sucursal(CodigoProveedor, NumeroSucursalProveedor);
CREATE NONCLUSTERED INDEX IX_Mae_PersonaJuridica_01 ON Mae_PersonaJuridica(NombreRazonSocial);

-- =====================================================
-- PASO 4: VERIFICACIÓN FINAL
-- =====================================================
-- Verificar estructura de todas las tablas
SELECT 
    TABLE_SCHEMA,
    TABLE_NAME,
    COLUMN_NAME,
    DATA_TYPE,
    CHARACTER_MAXIMUM_LENGTH,
    IS_NULLABLE
FROM INFORMATION_SCHEMA.COLUMNS 
WHERE TABLE_NAME IN (
    'Mae_Persona', 'Mae_PersonaJuridica', 'Mae_CompaniaSeguros',
    'Tip_Rol', 'Tip_TipoProveedor', 'Mae_Proveedor', 'Mae_Sucursal',
    'Tbt_PersonaRol', 'Tbt_PersonaCompaniaSeguro', 'Mae_SucursalCompaniaSeguro'
)
ORDER BY TABLE_NAME, ORDINAL_POSITION;

-- Verificar todas las Foreign Keys recreadas
SELECT 
    fk.name AS FK_Name,
    SCHEMA_NAME(tp.schema_id) + '.' + tp.name AS Parent_Table,
    cp.name AS Parent_Column,
    SCHEMA_NAME(tr.schema_id) + '.' + tr.name AS Referenced_Table,
    cr.name AS Referenced_Column
FROM sys.foreign_keys fk
INNER JOIN sys.tables tp ON fk.parent_object_id = tp.object_id
INNER JOIN sys.tables tr ON fk.referenced_object_id = tr.object_id
INNER JOIN sys.foreign_key_columns fkc ON fkc.constraint_object_id = fk.object_id
INNER JOIN sys.columns cp ON fkc.parent_column_id = cp.column_id AND fkc.parent_object_id = cp.object_id
INNER JOIN sys.columns cr ON fkc.referenced_column_id = cr.column_id AND fkc.referenced_object_id = cr.object_id
ORDER BY fk.name;

-- =====================================================
-- RESUMEN DE CAMBIOS REALIZADOS:
-- =====================================================
/*
✅ CAMBIOS PRINCIPALES:
   1. UNIQUEIDENTIFIER → VARCHAR(26) para IDs principales (ULID)
   2. Tip_Rol.IdTipoRol: VARCHAR(8) → VARCHAR(50)
   3. Todas las relaciones FK actualizadas correctamente
   4. Mantenida toda la estructura y lógica original
   5. Índices recreados para performance

📋 TABLAS AFECTADAS:
   • Mae_Persona (IdPersona: UNIQUEIDENTIFIER → VARCHAR(26))
   • Mae_PersonaJuridica (IdPersona: UNIQUEIDENTIFIER → VARCHAR(26))
   • Mae_CompaniaSeguros (Id's: UNIQUEIDENTIFIER → VARCHAR(26))
   • Tip_Rol (IdTipoRol: VARCHAR(8) → VARCHAR(50))
   • Tip_TipoProveedor (IdTipoProveedor: UNIQUEIDENTIFIER → VARCHAR(26))
   • Mae_Proveedor (Id's: UNIQUEIDENTIFIER → VARCHAR(26))
   • Mae_Sucursal (Id's: UNIQUEIDENTIFIER → VARCHAR(26))
   • Tbt_PersonaRol (Id's: UNIQUEIDENTIFIER/VARCHAR(8) → VARCHAR(26)/VARCHAR(50))
   • Tbt_PersonaCompaniaSeguro (Id's: UNIQUEIDENTIFIER → VARCHAR(26))
   • Mae_SucursalCompaniaSeguro (Id's: UNIQUEIDENTIFIER → VARCHAR(26))

🎯 BENEFICIOS DEL ULID:
   - Ordenamiento cronológico natural
   - Mejor performance en índices
   - Formato URL-safe
   - Compatible con sistemas distribuidos
   - Más legible que GUID

⚠️  IMPORTANTE:
   - Todos los datos existentes se perderán
   - Las aplicaciones necesitarán generar ULIDs válidos
   - Verificar que los sistemas puedan manejar VARCHAR(26) para IDs
*/
